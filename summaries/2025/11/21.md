# Activity Summary for 11/21/2025

## 3:26:37 PM
The log captures changes across two Go source files related to an "Integrity Handler" application.

**File-Specific Updates:**

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go**:
    *   This file, recorded at **11/21/2025, 2:26:50 PM**, defines a set of constant strings representing critical directory paths for the Integrity Handler. These include `BootDirPath` (`/boot/integrity`), `EncryptedKeyPath` (`/boot/integrity/femk.enc`), `MigrationDirPath` (`/opt/128technology/integrity/.migration-store`), `RecoveryDirPath` (`/opt/128technology/integrity/migration-recovery`), and `ManifestDirPath` (`/opt/128technology/integrity/manifest.d`). It establishes the fundamental locations where the Integrity Handler stores its data and encrypted keys.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go**:
    *   This file was recorded at **11/21/2025, 2:27:15 PM**, **2:27:22 PM**, **2:28:49 PM**, and **2:40:35 PM**. Across these timestamps, the code content remained identical, suggesting multiple saves or commits of the same version without functional changes within this log.
    *   The file implements the core logic of the Integrity Handler. Key functions include:
        *   `verifyAndInitializeEnvironment`: Checks system requirements such as running as root, kernel version (>= 5.4), filesystem encryption support (via `fscrypt`), and TPM/vTPM initialization.
        *   `enableIntegrity`: An idempotent function responsible for ensuring necessary directories exist, resolving a File Encryption Master Key (FEMK), setting up `fscrypt` on the mount, and encrypting target directories.
        *   `unlockEncryptedDirs`: Uses the resolved filesystem key to unlock encrypted directories, treating most failures as integrity compromises.
        *   `getFsKey`: A lazy-loading function to retrieve the filesystem key from a secure vault after decrypting the FEMK, with explicit zeroing of the plaintext key slice for security.
        *   `ensureDirectoriesExist`: Creates all required directories with specific permissions (e.g., `0o750` for migration/recovery/manifest, `0o700` for boot integrity dir) and attempts to clean the migration directory.
        *   `handleRecoveryDirectoryWarnings`: Checks for contents in the recovery directory and logs warnings if data is found, indicating potential issues requiring manual intervention.

**Patterns and Recurring Elements:**

*   **Copyright Notice**: All provided code snippets begin with `// Copyright (c) Juniper Networks, Inc. 2025. All rights reserved.`, indicating consistent ownership and intellectual property declarations.
*   **Security and Integrity Focus**: The entire codebase is centered around system integrity, utilizing `fscrypt` for filesystem encryption, TPM for key protection, and a `vault.SecureContainer` for secure in-memory key storage. The `errIntegrityCompromised` error signifies a critical security aspect.
*   **Go Language Conventions**: Adherence to standard Go practices, including structured error handling (`fmt.Errorf` with `%w`), package imports, and descriptive function names.
*   **Directory Management**: Frequent use of the `afero` filesystem abstraction for robust directory creation, existence checks, and cleanup, leveraging constants defined in `common/directories.go`.
*   **Logging**: Consistent use of a `log` package (e.g., `log.Debug`, `log.Warnf`, `log.Errorf`) for reporting operational status and issues.

## 4:26:45 PM
The logs show a focused development effort on an "Integrity Handler" application, primarily written in Go, with multiple updates occurring on November 21, 2025. The application is designed to manage filesystem encryption and ensure system integrity, leveraging `fscrypt` and TPM/vTPM.

**File-Specific Updates:**

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go`**
    *   **Initial state (11/21/2025, 2:26:50 PM):** This file defines key directory paths as constants for the Integrity Handler, including `/boot/integrity`, `/boot/integrity/femk.enc` (for the encrypted FEMK - File Encryption Master Key), `/opt/128technology/integrity/.migration-store`, `/opt/128technology/integrity/migration-recovery`, and `/opt/128technology/integrity/manifest.d`. The package comment mentions a secure container for keys using mmap'ed and mlocked memory.
    *   **Later update (11/21/2025, 4:02:40 PM):** The package-level comment was changed from a detailed description of secure key containers to a more general `Package common contains common globals used throughout Integrity Handler.`, simplifying the documentation for this specific file. The directory constants themselves remained unchanged.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go`**
    *   **Multiple timestamps (11/21/2025, 2:27:15 PM, 2:27:22 PM, 2:28:49 PM, 2:40:35 PM):** This is a core application file. The content appears to be stable across these timestamps, suggesting minor non-code changes or repeated saves. Key functionalities include:
        *   **Environment verification:** `verifyAndInitializeEnvironment` checks if the application runs as root, if the kernel version is at least 5.4, if the filesystem supports encryption (using `fscrypt`'s `CheckSupport`), if the `fscrypt` command is installed, and initializes the TPM via `tpm.InitializeTPM`.
        *   **Integrity enablement:** `enableIntegrity` is an idempotent function that ensures necessary directories exist (`ensureDirectoriesExist`), creates and resolves the FEMK, sets up `fscrypt` on the mount point, and orchestrates the encryption of target directories using `fscrypt.EncryptTargetDirs`.
        *   **Key management:** `getFsKey` lazy-loads the filesystem key, decrypting the FEMK, securing it in a `vault.SecureContainer`, and then securely wiping the original plain key.
        *   **Directory management:** `ensureDirectoriesExist` creates all required directories with specific permissions (0o750 or 0o700) and attempts to clean the migration directory. `handleRecoveryDirectoryWarnings` checks for any leftover data in the recovery directory, logging warnings if found, indicating potential past failures requiring manual intervention.
        *   **Error handling:** Defines `errIntegrityCompromised` and uses structured error wrapping (`fmt.Errorf("%w: %w", ...)`) throughout.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go`**
    *   **First appearance (11/21/2025, 4:00:45 PM):** This is the entry point for the Integrity Handler application.
        *   It defines `ExitCode` constants (`ExitSuccess`, `ExitFailure`, `ExitIncompatible`, `ExitCompromised`) that align with systemd service return codes.
        *   The `main` function initializes logging, parses a `mountPath` flag, and calls the `run` function.
        *   The `run` function orchestrates the application logic: logging the version, setting up application state, handling recovery directory warnings, verifying the environment, enabling integrity, and unlocking encrypted directories. It handles different error conditions, returning specific `ExitCode` values, particularly distinguishing between incompatible environments, general failures, and integrity compromises.
        *   Uses `//go:embed` to include the application version.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go`**
    *   **First appearance (11/21/2025, 4:11:30 PM):** This file provides high-level wrappers for `fscrypt` operations.
        *   It defines a set of specific error types related to `fscrypt` failures (e.g., `ErrTargetAlreadyEncrypted`, `ErrFailedToRelocate`, `ErrFscryptNotSupportedOnMount`).
        *   `SetupOnMount` handles global `fscrypt` configuration and filesystem-specific setup.
        *   The `EncryptionResult` struct tracks the outcome of encryption operations, categorizing directories as `Success`, `AlreadyEncrypted`, or various failure types (e.g., `FailedToRelocate`, `FailedToEncrypt`, `FailedToUnlock`). It includes methods `Failed()` to check for any critical failures and `BuildError()` to generate a composite error message.
        *   `EncryptTargetDirs` is an idempotent function that iterates through target directories, checking if they are already encrypted before attempting `encryptTargetDir`.
        *   `encryptTargetDir` implements the core encryption logic: relocating directory contents to a temporary location, recreating the target directory with appropriate permissions, encrypting the empty target, and then (implicitly, though not fully shown in the snippet) restoring the contents or moving them to a recovery directory in case of failure.

**Patterns and Recurring Elements:**

*   **Copyright and Licensing:** All code snippets include the copyright `// Copyright (c) Juniper Networks, Inc. 2025. All rights reserved.`
*   **Security Focus:** There's a strong emphasis on security and integrity, indicated by the name "Integrity Handler," use of `fscrypt` for encryption, reliance on TPM, secure key handling (secure containers, key wiping), and explicit checks for integrity compromises.
*   **Structured Error Handling:** The code consistently uses Go's error wrapping (`fmt.Errorf("%w: %w", ...)`) and error joining (`errors.Join`) to provide rich error contexts. Custom error types are defined for specific failure conditions.
*   **Idempotency:** Several critical functions, such as `enableIntegrity` and `EncryptTargetDirs`, are explicitly designed to be idempotent, ensuring that repeated calls do not cause unintended side effects and can safely re-establish a desired state.
*   **Filesystem Abstraction:** The `afero.Fs` interface is used for filesystem operations, allowing for easier testing and potentially different backend storage implementations.
*   **Directory Management and Recovery:** The application manages several dedicated directories for migration, recovery, and manifests, demonstrating a robust approach to managing intermediate states and potential failure scenarios during encryption processes.
*   **Logging:** The `log` package is extensively used (`log.Debug`, `log.Info`, `log.Warn`, `log.Error`) for tracing execution, diagnostics, and reporting operational status and issues.
*   **Timestamps:** All changes are concentrated on a single date, November 21, 2025, suggesting a coordinated development or refactoring effort around the Integrity Handler application.

## 5:26:45 PM
The provided log details code changes for an "Integrity Handler" application, primarily focusing on filesystem encryption and integrity verification, all dated 11/21/2025.

**File-Specific Updates:**

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go`**
    *   **Initial Update (11/21/2025, 2:26:50 PM):** This file was introduced to define common directory constants used by the Integrity Handler. Key paths include `/boot/integrity` (for handler files and encrypted FEMK), `/opt/128technology/integrity/.migration-store` (for migration data), `/opt/128technology/integrity/migration-recovery` (for failure recovery data), and `/opt/128technology/integrity/manifest.d` (for integrity manifest files).
    *   **Minor Update (11/21/2025, 4:02:40 PM):** A small textual change was made to the package comment, updating it from a detailed description of key container functionality to a more general statement: `// Package common contains common globals used throughout Integrity Handler.` The defined constants remained unchanged.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go`**
    *   **Initial & Subsequent Updates (11/21/2025, 2:27:15 PM, 2:27:22 PM, 2:28:49 PM, 2:40:35 PM):** This file provides the core logic for the Integrity Handler. It includes functions for:
        *   `verifyAndInitializeEnvironment`: Checks system requirements such as root privileges, kernel version (>= 5.4), filesystem encryption support (via `fscrypt`), and TPM initialization.
        *   `enableIntegrity`: Orchestrates the encryption process, ensuring necessary directories exist, resolving the File Encryption Master Key (FEMK), setting up `fscrypt` on the mount, and encrypting target directories. It is designed to be idempotent.
        *   `unlockEncryptedDirs`: Handles unlocking previously encrypted directories, with failures treated as integrity compromises.
        *   `getFsKey`: A lazy-loading mechanism to retrieve the filesystem key from a secure container, with explicit memory wiping of the plain key.
        *   `ensureDirectoriesExist`: Creates all required integrity handler directories (`MigrationDirPath`, `RecoveryDirPath`, `ManifestDirPath`, `BootDirPath`) with appropriate permissions, and attempts to clean the migration directory.
        *   `handleRecoveryDirectoryWarnings`: Checks for existing contents in the recovery directory and logs warnings if manual intervention is needed.
    *   Notably, the content of this file remained identical across the four timestamps between 2:27 PM and 2:40 PM, suggesting no functional changes were committed in those specific time intervals.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go`**
    *   **Initial Update (11/21/2025, 4:00:45 PM):** This new file introduces the application's entry point. It sets up logging, parses a `mount` command-line flag, and defines `ExitCode` constants (`ExitSuccess`, `ExitFailure`, `ExitIncompatible`, `ExitCompromised`) for standardized process return values. The `run` function orchestrates the main workflow, including environment verification, handling recovery warnings, enabling integrity, and unlocking directories, mapping various outcomes to the defined `ExitCode`s. It also embeds the application version using `//go:embed`.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go`**
    *   **Initial Update (11/21/2025, 4:11:30 PM):** This new file implements high-level wrappers around `fscrypt` functionality. It defines several specific error types related to encryption and relocation. Key functions include:
        *   `SetupOnMount`: Performs global and filesystem-specific `fscrypt` setup for a given mount path, designed to be idempotent.
        *   `EncryptionResult`: A struct to track the detailed outcome of encryption attempts, categorizing successes and various types of failures (e.g., failed to relocate, encrypt, unlock, restore, recover).
        *   `EncryptTargetDirs`: Iterates through target directories, checking if they are already encrypted before attempting to encrypt each one.
        *   `encryptTargetDir`: Contains the core logic for encrypting a single directory. This involves temporarily relocating its contents, recreating the target directory as empty, encrypting it, and handling potential errors.

**Patterns and Recurring Elements:**

*   **Copyright and Versioning:** All files begin with a Juniper Networks copyright notice for 2025. The `main.go` file explicitly embeds an `integrity-handler.version` string.
*   **Security Focus:** A strong emphasis on security is evident through the use of `fscrypt`, TPM/vTPM initialization, secure containers (`vault.SecureContainer`), memory wiping for sensitive keys, and explicit checks for integrity compromise.
*   **Robust Error Handling:** The codebase consistently uses Go's `errors` package features (`errors.New`, `fmt.Errorf("%w: %w", ...)`, `errors.Is`, `errors.As`, `errors.Join`) for detailed error creation, wrapping, and checking.
*   **Directory Management:** The `common/directories.go` file serves as a central point for defining critical filesystem paths, which are then consistently utilized across `integrity.go` and `fscrypt/fscrypt.go` for operations like creating, cleaning, and relocating data.
*   **Idempotency:** Several key functions, such as `enableIntegrity` and `SetupOnMount`, are explicitly designed or stated to be idempotent, ensuring that repeated calls do not cause unintended side effects.
*   **Logging:** The application uses a custom `log` package (`github.com/Juniper-SSN/ssr/go/src/log`) with various levels (`Debug`, `Info`, `Warn`, `Error`) for detailed operational feedback.
*   **Filesystem Abstraction:** The `github.com/spf13/afero` library is used to provide an abstract filesystem interface, which is beneficial for testing and mock operations.
*   **Consistent Timestamp:** All changes occurred on the same date, 11/21/2025, indicating focused development activity on the Integrity Handler component during that period.

## 6:26:47 PM
The provided log entries detail the development of an "Integrity Handler" application in Go, primarily focusing on securing directories through filesystem encryption and managing associated keys. The overarching goal is to ensure system integrity and handle potential compromises.

**File-Specific Updates:**

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go`**
    *   **Timestamp: 11/21/2025, 2:26:50 PM:** This file was initially defined, establishing constant paths for the Integrity Handler's critical directories. These include `/boot/integrity` for core files, `/boot/integrity/femk.enc` for the encrypted File Encryption Master Key (FEMK), and `/opt/128technology/integrity/.migration-store`, `/opt/128technology/integrity/migration-recovery`, and `/opt/128technology/integrity/manifest.d` for migration data, recovery data, and integrity manifest files, respectively. The package comment highlighted its role in holding secure keys at runtime.
    *   **Timestamp: 11/21/2025, 4:02:40 PM:** A minor update occurred, changing the package comment from detailing key storage to a more general "contains common globals used throughout Integrity Handler." The defined constants remained unchanged.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go`**
    *   **Timestamps: 11/21/2025, 2:27:15 PM; 11/21/2025, 2:27:22 PM; 11/21/2025, 2:28:49 PM; 11/21/2025, 2:40:35 PM:** This file remained consistent across multiple log entries, indicating no functional code changes were introduced between these specific timestamps. It contains the core logic for the Integrity Handler:
        *   **Environment Verification:** A `verifyAndInitializeEnvironment` function ensures the system meets requirements, checking for root privileges, a Linux kernel version of 5.4 or higher, filesystem encryption support (via `fscrypt` metadata and command availability), and TPM/vTPM initialization.
        *   **Integrity Enabling and Unlocking:** Functions like `enableIntegrity` (which must be idempotent) and `unlockEncryptedDirs` handle the encryption and decryption processes for target directories. These functions rely on a `vault.SecureContainer` to manage the filesystem key, which is lazy-loaded from a decrypted FEMK.
        *   **Directory Management:** The `ensureDirectoriesExist` function creates all necessary Integrity Handler directories with specific permissions (0o750 or 0o700) and attempts to clean the migration store.
        *   **Recovery Handling:** `handleRecoveryDirectoryWarnings` checks the recovery directory for any leftover contents, indicating a previous failure that requires manual intervention.
        *   Integrity Compromise: An `errIntegrityCompromised` error is defined and returned in cases where decryption or key handling fails, signifying a security breach.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go`**
    *   **Timestamp: 11/21/2025, 4:00:45 PM:** This file defines the entry point and overall orchestration for the Integrity Handler application.
        *   **Exit Codes:** Introduces custom `ExitCode` constants (`ExitSuccess`, `ExitFailure`, `ExitIncompatible`, `ExitCompromised`) which align with systemd service return codes to clearly communicate the application's final state.
        *   **Main Flow:** The `run` function sets up logging, parses a `-mount` command-line flag, verifies the environment, handles recovery warnings, enables integrity (encrypting target directories), and then unlocks any already encrypted directories. It handles errors at each stage, returning the appropriate `ExitCode`.
        *   **Version Management:** Includes an embedded version string `integrity-handler.version` for reporting the application's version.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go`**
    *   **Timestamp: 11/21/2025, 4:11:30 PM:** This file was introduced to provide high-level wrappers for `fscrypt` operations, abstracting the details of filesystem encryption.
        *   **Error Definitions:** Defines several specific error types related to `fscrypt` operations, such as `ErrTargetAlreadyEncrypted`, `ErrDestinationNotEmpty`, `ErrFailedToRelocate`, and errors related to `fscrypt` support on the mount.
        *   **Protector Name:** Defines `protectorName` as "FEMK".
        *   **`fscrypt` Setup:** The `SetupOnMount` function performs global `fscrypt` configuration and sets it up for a specific mount path, handling cases where it's already configured.
        *   **Encryption Process:** `EncryptTargetDirs` orchestrates the encryption of multiple directories. The core `encryptTargetDir` function implements a complex, idempotent process: it first moves existing directory contents to a temporary migration directory, recreates the target directory as an empty, encrypted directory, and then implicitly moves the contents back (though the full restore logic isn't shown in the snippet).
        *   **`EncryptionResult`:** A struct `EncryptionResult` is used to provide a detailed breakdown of the encryption attempt's outcome, tracking successes and various types of failures (relocation, encryption, unlocking, restoring, recovering).

**Patterns and Recurring Elements:**

*   **Juniper Networks Copyright:** All files consistently feature the copyright notice `// Copyright (c) Juniper Networks, Inc. 2025. All rights reserved.`.
*   **Strong Security Posture:** The codebase prioritizes security through filesystem encryption (`fscrypt`), hardware-backed key management (TPM/vTPM, FEMK), secure key containers (`vault.SecureContainer`), and explicit handling of integrity compromises.
*   **Robust Error Handling:** Extensive use of Go's error wrapping (`fmt.Errorf("%w: %w", ...)`), `errors.Is`, and `errors.Join` ensures detailed and contextual error reporting. Specific exit codes are used to categorize failures.
*   **Idempotency:** Key functions like `enableIntegrity` and `EncryptTargetDirs` are explicitly designed to be idempotent, allowing them to be run multiple times without unintended side effects.
*   **Detailed Logging:** The application utilizes a custom `log` package (from `github.com/Juniper-SSN/ssr/go/src/log`) with various levels (Debug, Info, Warnf, Errorf) for comprehensive execution tracing and issue reporting.
*   **Directory Management:** Consistent creation and management of application-specific directories (`/boot/integrity`, `/opt/128technology/integrity/...`) with defined permissions, often involving temporary relocation for encryption.
*   **`TODO` Comments:** The presence of `TODO` comments throughout the code indicates ongoing development, future enhancements, and areas requiring further consideration (e.g., "best effort shred," manifest processing, upgrade path for `path` variable).

## 7:26:44 PM
The provided log details changes across the Integrity Handler application, primarily focusing on filesystem encryption and security.

**File-Specific Updates:**

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go**
    *   **Initial state (11/21/2025, 2:26:50 PM):** This file defines essential directory paths for the Integrity Handler. Key paths include `/boot/integrity` (for handler files), `/boot/integrity/femk.enc` (for the encrypted File Encryption Master Key - FEMK), `/opt/128technology/integrity/.migration-store` (for migration data), `/opt/128technology/integrity/migration-recovery` (for recovery data), and `/opt/128technology/integrity/manifest.d` (for integrity manifests). The package comment indicates its role in holding keys securely at runtime and providing common variables.
    *   **Later update (11/21/2025, 4:02:40 PM):** The package-level comment was refined from describing "a secure container" to stating it "contains common globals used throughout Integrity Handler." The defined directory paths and their purposes remained unchanged.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go**
    *   **Initial state (11/21/2025, 2:27:15 PM):** This file contains the core logic for the Integrity Handler. It defines an `errIntegrityCompromised` error. Key functions include:
        *   `verifyAndInitializeEnvironment`: Checks system prerequisites like being run as root, kernel version (>= 5.4), filesystem encryption support (using `fscrypt.CheckSupport`), `fscrypt` command availability, and TPM initialization (`tpm.InitializeTPM`).
        *   `enableIntegrity`: An idempotent function that ensures necessary directories exist, creates and resolves the FEMK, sets up `fscrypt` on the mount, and encrypts target directories.
        *   `unlockEncryptedDirs`: Unlocks encrypted directories using the filesystem key, reporting integrity compromise on failure.
        *   `getFsKey`: A lazy-loading function to decrypt the FEMK and store the plain key in a secure vault, ensuring the original key slice is wiped afterwards.
        *   `ensureDirectoriesExist`: Creates and sets permissions for the application's required directories (migration, recovery, manifest, boot), including cleaning the migration directory.
        *   `handleRecoveryDirectoryWarnings`: Checks for and logs warnings about contents found in the recovery directory, indicating a need for manual intervention.
    *   **Subsequent updates (11/21/2025, 2:27:22 PM; 11/21/2025, 2:28:49 PM; 11/21/2025, 2:40:35 PM):** The content of this file remained identical across these three timestamps, suggesting minor non-functional changes like file saves or automated reformatting without code alterations.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go**
    *   **Single update (11/21/2025, 4:00:45 PM):** This is the main entry point for the Integrity Handler. It defines `ExitCode` constants for different application outcomes (success, failure, incompatible environment, integrity compromised). The `main` function parses a `mountPath` argument, sets up logging, and calls the `run` function. The `run` function orchestrates the integrity process: logging version, initializing application state, handling recovery warnings, verifying the environment, enabling integrity on target directories (obtained from `DefaultManifest`), and unlocking already encrypted directories. It handles errors by returning specific `ExitCode` values, particularly `ExitCompromised` for integrity violations.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go**
    *   **Single update (11/21/2025, 4:11:30 PM):** This file provides high-level wrappers for `fscrypt` operations. It defines various error types related to encryption targets, directory states, and `fscrypt` support. Key components include:
        *   `protectorName`: A constant "FEMK" for the protector.
        *   `SetupOnMount`: An idempotent function to perform global and filesystem-specific `fscrypt` setup for a given mount point.
        *   `EncryptionResult`: A struct to track the detailed outcome of encryption attempts for multiple targets (success, already encrypted, various failure modes like relocation, encryption, unlocking, restoring, recovery failures). It includes methods to check if failures occurred and to build a composite error message.
        *   `EncryptTargetDirs`: An idempotent function that iterates through target directories, checks if they are already encrypted, and calls `encryptTargetDir` for unencrypted ones.
        *   `encryptTargetDir`: This function orchestrates the encryption of a single target directory. It involves moving existing contents out to a temporary migration directory, recreating the target directory as empty with original permissions, encrypting the empty target, and then implicitly (based on comments) moving the contents back. It includes logic for moving contents to a recovery directory in case of severe failures.

**Timestamps of Significant Changes:**

*   **11/21/2025, 2:26:50 PM:** Initial definition of `common/directories.go`, establishing key paths.
*   **11/21/2025, 2:27:15 PM:** Initial comprehensive implementation of `integrity.go`, including environment verification, encryption enabling, and key management.
*   **11/21/2025, 4:00:45 PM:** Implementation of `main.go`, setting up the application's entry point, argument parsing, execution flow, and specific exit codes.
*   **11/21/2025, 4:02:40 PM:** A minor refactor in `common/directories.go`, updating a package-level comment.
*   **11/21/2025, 4:11:30 PM:** Implementation of `fscrypt/fscrypt.go`, detailing the `fscrypt` interaction, setup, and robust encryption/recovery logic for target directories.

**Patterns and Recurring Elements:**

*   **Copyright Header:** All Go files consistently include the copyright notice "// Copyright (c) Juniper Networks, Inc. 2025. All rights reserved."
*   **Integrity Focus:** The entire codebase is dedicated to an "Integrity Handler" application, emphasizing secure containerization, filesystem encryption (using `fscrypt`), and TPM integration for key protection.
*   **Key Management and Security:** The File Encryption Master Key (FEMK) is a central element, with procedures for encryption, decryption, secure storage in a `vault.SecureContainer`, and wiping of plain key material. TPM initialization is a prerequisite for FEMK encryption.
*   **Idempotency:** Several critical functions, such as `enableIntegrity` and `EncryptTargetDirs`, are explicitly designed to be idempotent, meaning they can be safely called multiple times without unintended side effects.
*   **Robust Error Handling and Recovery:** The application defines specific error types (`errIntegrityCompromised`, various `ExitCode` values) and includes mechanisms for handling failures, such as moving data to recovery directories and logging warnings for manual intervention.
*   **Directory Standardization:** The `common/directories.go` file centralizes all special directory paths, which are consistently used across `integrity.go` and `fscrypt/fscrypt.go` for managing migration, recovery, manifests, and boot-time integrity files.
*   **Dependencies:** The project heavily relies on external libraries like `github.com/google/fscrypt` for filesystem encryption, `github.com/spf13/afero` for abstract filesystem operations, and internal Juniper logging and vault packages.
*   **Minor Resaves:** There were multiple timestamps for `integrity.go` where the file content did not change, indicating frequent saves or automated operations without functional code alterations.

## 8:26:43 PM
The code changes primarily revolve around the `Integrity Handler` application, a Go program designed to manage encrypted file systems using `fscrypt` and TPM/vTPM, focusing on secure handling of keys and robust directory management. All files share a common copyright notice: `// Copyright (c) Juniper Networks, Inc. 2025. All rights reserved.`. There's a consistent focus on security, robust error handling, and ensuring idempotent operations.

**File-specific Updates and Timestamps:**

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go**
    *   **Timestamp: 11/21/2025, 2:26:50 PM**
        This file defines constants for critical directory paths used by the Integrity Handler, such as `/boot/integrity` (for handler files and the encrypted FEMK), `/opt/128technology/integrity/.migration-store` (for migration data), `/opt/128technology/integrity/migration-recovery` (for recovery data), and `/opt/128technology/integrity/manifest.d` (for manifest files).
    *   **Timestamp: 11/21/2025, 4:02:40 PM**
        A minor change occurred here, updating the package comment from a detailed description about secure container and mmap'ed memory to a more general "contains common globals used throughout Integrity Handler." The defined directory constants remain unchanged.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go**
    *   **Timestamp: 11/21/2025, 2:27:15 PM**
        This core file implements the main logic for the Integrity Handler. It defines an `errIntegrityCompromised` error and several key functions:
        *   `verifyAndInitializeEnvironment`: Checks system prerequisites like running as root, kernel version (>= 5.4), filesystem encryption support (via `fscrypt/metadata.CheckSupport`), `fscrypt` command availability, and TPM/vTPM initialization.
        *   `enableIntegrity`: Orchestrates the encryption process, ensuring directories exist, resolving and securely storing the FEMK, setting up `fscrypt` on the mount, and encrypting target directories. It explicitly states a requirement for idempotency.
        *   `unlockEncryptedDirs`: Handles unlocking previously encrypted directories.
        *   `getFsKey`: A lazy-loading function to decrypt the FEMK and store the plaintext key in a `vault.SecureContainer`, ensuring the original key slice is wiped for security.
        *   `ensureDirectoriesExist`: Creates all necessary directories defined in `common/directories.go` with specific permissions (`0o750` or `0o700`) and includes logic to clean the migration directory.
        *   `handleRecoveryDirectoryWarnings`: Checks for leftover contents in the recovery directory, logging warnings if manual intervention might be needed after a migration failure.
    *   **Timestamps: 11/21/2025, 2:27:22 PM, 2:28:49 PM, 2:40:35 PM**
        These timestamps show no functional or content changes to the `integrity.go` file from the previous version. They likely represent minor saves or reformatting without code alterations.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go**
    *   **Timestamp: 11/21/2025, 4:00:45 PM**
        This file contains the entry point (`main` function) for the Integrity Handler application.
        *   It defines `ExitCode` constants (`ExitSuccess`, `ExitFailure`, `ExitIncompatible`, `ExitCompromised`) that align with systemd service return codes.
        *   It uses `go:embed` to include the application version.
        *   The `main` function sets the log level, parses a `-mount` flag, and then calls the `run` function.
        *   The `run` function logs the application version, initializes the application state, calls `handleRecoveryDirectoryWarnings`, performs environment verification, then proceeds to `enableIntegrity` and `unlockEncryptedDirs`. It includes detailed error handling to return appropriate `ExitCode`s based on various failure scenarios, including integrity compromises and incompatible environments.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go**
    *   **Timestamp: 11/21/2025, 4:11:30 PM**
        This file provides high-level Go wrappers for `fscrypt` operations.
        *   It defines numerous custom `error` constants to clearly indicate specific `fscrypt`-related failures (e.g., `ErrTargetAlreadyEncrypted`, `ErrDestinationNotEmpty`, `ErrFscryptNotSupportedOnMount`).
        *   The `protectorName` constant is set to "FEMK".
        *   `SetupOnMount`: Handles global `fscrypt` configuration and filesystem-specific setup, designed to be idempotent.
        *   `EncryptionResult` struct: A detailed structure to track the outcome of encrypting multiple directories, categorizing results into success, already encrypted, and various failure types (relocation, encryption, unlock, restore, recovery). It includes `Failed()` and `BuildError()` methods for consolidated status checking and error reporting.
        *   `EncryptTargetDirs`: An idempotent function that iterates through target directories and calls `encryptTargetDir` for each.
        *   `encryptTargetDir`: This crucial function is responsible for encrypting a single directory. It first attempts to move the directory's contents to a temporary migration path, recreates the target directory as an empty one (retaining original permissions), and then encrypts the empty target directory. It includes robust error handling to move contents to a recovery directory if subsequent steps fail.

**Patterns and Recurring Elements:**

*   **Security-First Design:** The pervasive use of `fscrypt`, TPM/vTPM, `vault.SecureContainer`, and explicit key-wiping indicates a strong emphasis on data security and integrity.
*   **Structured Error Handling:** Go's `errors` package features (`errors.New`, `fmt.Errorf`, `errors.As`, `errors.Join`) are consistently used across files for precise error reporting and propagation, often wrapping underlying errors.
*   **Directory Path Constants:** All files, particularly `integrity.go` and `fscrypt.go`, heavily rely on the standardized directory paths defined in `common/directories.go`.
*   **Idempotency:** The concept of idempotency is explicitly mentioned for critical operations like `enableIntegrity` and `EncryptTargetDirs`, ensuring that repeated calls do not lead to unintended side effects.
*   **Logging:** The `log` package (`github.com/Juniper-SSN/ssr/go/src/log`) is used extensively for debugging, informational messages, warnings, and error reporting, providing visibility into the application's state and issues.
*   **Filesystem Abstraction:** The `github.com/spf13/afero` library is used for filesystem operations, offering an abstracted and testable interface.
*   **Version Control and Timestamps:** The timestamps are tightly clustered within a couple of hours on the same day, suggesting a focused period of development or refinement of these specific features. The minor content changes in `integrity.go` across multiple timestamps might indicate frequent saves during active development, while the `common/directories.go` update is a comment change, and `main.go` and `fscrypt.go` represent distinct functional additions.

## 9:26:50 PM
The provided code logs detail the development of an Integrity Handler application in Go, primarily focusing on filesystem encryption, key management, and system integrity verification. The changes span three main files: `common/directories.go`, `integrity.go`, and `main.go`, with a new file `fscrypt/fscrypt.go` introduced later in the log.

### File-Specific Updates:

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go`**
    *   **Initial (11/21/2025, 2:26:50 PM)**: This file defines essential directory paths as constants for the Integrity Handler: `/boot/integrity` (BootDirPath), `/boot/integrity/femk.enc` (EncryptedKeyPath for the File Encryption Master Key), `/opt/128technology/integrity/.migration-store` (MigrationDirPath), `/opt/128technology/integrity/migration-recovery` (RecoveryDirPath), and `/opt/128technology/integrity/manifest.d` (ManifestDirPath). The initial package comment highlighted its role in securing keys at runtime using mmap'ed memory.
    *   **Update (11/21/2025, 4:02:40 PM)**: A minor, non-functional change occurred. The package comment was simplified to "Package common contains common globals used throughout Integrity Handler," while the defined constants remained the same.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go`**
    *   **Multiple identical updates (11/21/2025, 2:27:15 PM, 2:27:22 PM, 2:28:49 PM, 2:40:35 PM)**: This core application logic file remained functionally unchanged across these timestamps, suggesting repeated saves or intermediate state capturing without code modifications.
    *   **Functionality**: This file implements the main integrity features. It includes functions for:
        *   `verifyAndInitializeEnvironment`: Checks system requirements like root privileges, kernel version (>= 5.4), filesystem encryption support (using `fscrypt`), presence of the `fscrypt` command, and TPM (Trusted Platform Module) initialization.
        *   `enableIntegrity`: Designed to be idempotent, it ensures required directories exist, handles FEMK (File Encryption Master Key) creation/resolution, sets up `fscrypt` on the mount, and encrypts specified target directories.
        *   `unlockEncryptedDirs`: Unlocks encrypted directories, reporting `errIntegrityCompromised` on failure.
        *   `getFsKey`: A lazy-loading function that decrypts the FEMK, stores the key in a `vault.SecureContainer`, and securely wipes the plaintext key.
        *   `ensureDirectoriesExist`: Creates all necessary directories (`MigrationDirPath`, `RecoveryDirPath`, `ManifestDirPath`, `BootDirPath`) with appropriate permissions (`0o750` or `0o700`) and includes logic to clean the migration directory.
        *   `handleRecoveryDirectoryWarnings`: Checks and warns if any residual data is found in the recovery directory, indicating potential issues requiring manual intervention.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go`**
    *   **Initial (11/21/2025, 4:00:45 PM)**: This file acts as the application's entry point and orchestrator.
    *   **Key features**:
        *   Defines specific `ExitCode` constants (`ExitSuccess`, `ExitFailure`, `ExitIncompatible`, `ExitCompromised`) that align with `systemd` service return codes for clear status reporting.
        *   Embeds the application version string (`integrity-handler.version`) directly into the binary.
        *   The `main` function initializes logging, parses a `mount` path argument, and calls the `run` function.
        *   The `run` function coordinates the entire integrity process: it logs the version, sets up application state, handles recovery warnings, verifies the environment (exiting with `ExitIncompatible` if checks fail), determines targets for encryption (via `DefaultManifest()`), calls `enableIntegrity`, and then `unlockEncryptedDirs` for already encrypted targets. It handles different error outcomes, returning `ExitCompromised` for integrity violations or `ExitFailure` for other issues.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go`**
    *   **Initial (11/21/2025, 4:11:30 PM)**: This newly added file provides high-level abstractions for interacting with the `fscrypt` utility.
    *   **Key components**:
        *   Defines numerous custom error constants specific to `fscrypt` operations (e.g., `ErrTargetAlreadyEncrypted`, `ErrDestinationNotEmpty`, `ErrFscryptNotSupportedOnMount`).
        *   Sets a `protectorName` constant to "FEMK".
        *   `SetupOnMount`: An idempotent function to perform global `fscrypt` setup and then configure `fscrypt` for a specified mount point.
        *   `EncryptionResult` struct: A detailed structure to track the outcome of encrypting multiple directories, categorizing successes, already encrypted paths, and various failure types (relocation, encryption, unlock, restore, recover). It includes methods to check for any hard failures (`Failed()`) and aggregate errors into a single report (`BuildError()`).
        *   `EncryptTargetDirs`: Iterates through a list of target directories, checking if they are already encrypted before attempting encryption via `encryptTargetDir`.
        *   `encryptTargetDir` (partial): Outlines the steps for encrypting a single directory, which involves relocating its contents to a temporary directory, recreating the target directory with original permissions, encrypting the now-empty target, and robust error handling including moving contents to a recovery directory upon failure.

### Patterns and Recurring Elements:

*   **Strong Security Focus**: The entire codebase is designed around ensuring system integrity through filesystem encryption, secure key storage (FEMK, TPM, vault), and robust error handling for integrity compromises.
*   **Idempotency**: Critical functions like `enableIntegrity` and `fscrypt.SetupOnMount` are explicitly designed to be idempotent, allowing them to be run multiple times safely.
*   **Comprehensive Error Handling**: Extensive use of custom error types and error wrapping (`fmt.Errorf("%w: %w", parent, child)`) is prevalent throughout the code, providing detailed diagnostic information. Specific exit codes are used to signal different types of application failures to the system (e.g., `systemd`).
*   **Directory Management**: The `common` package centralizes path definitions, and functions like `ensureDirectoriesExist` manage the lifecycle of various operational directories, including clean-up and recovery mechanisms.
*   **Timestamp Proximity**: The repeated entries for `integrity.go` within a short time frame (2:27 PM to 2:40 PM) suggest rapid development, frequent saving, or an automated logging process capturing minor, non-functional updates.
*   **Copyright Attribution**: All files include a "Copyright (c) Juniper Networks, Inc. 2025. All rights reserved." header, indicating corporate ownership.
*   **`TODO` Comments**: Several `TODO` comments are present, highlighting areas for future enhancements, such as "best effort shred" for data cleaning, manifest processing, and context plumbing.

## 10:26:49 PM
The provided log details recent changes to the Integrity Handler application written in Go, focusing on its core logic and filesystem encryption capabilities.

**File-specific updates and significant timestamps:**

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go:**
    *   **11/21/2025, 2:26:50 PM**: This file was initially defined, establishing constant paths crucial for the Integrity Handler's operation. These include `BootDirPath`, `EncryptedKeyPath` (for the File Encryption Master Key - FEMK), `MigrationDirPath`, `RecoveryDirPath`, and `ManifestDirPath`.
    *   **11/21/2025, 4:02:40 PM**: A minor update occurred, refining the package comment from a grammatically awkward phrase to "Package common contains common globals used throughout Integrity Handler," without changing the constants themselves.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go:**
    *   **11/21/2025, 2:27:15 PM**: A substantial update or initial check-in of the core `integrity.go` file. This version defines key functions like `verifyAndInitializeEnvironment` (which checks for root privileges, kernel version, filesystem encryption support, `fscrypt` command presence, and TPM initialization), `enableIntegrity` (responsible for directory setup, FEMK resolution, and target directory encryption), `unlockEncryptedDirs`, `getFsKey` (for secure key loading), `ensureDirectoriesExist` (for creating necessary application directories), and `handleRecoveryDirectoryWarnings` (to alert about data in recovery directories).
    *   **11/21/2025, 2:27:22 PM**: This entry shows the file content as identical to the previous timestamp, indicating no functional changes were made in this specific commit.
    *   **11/21/2025, 2:28:49 PM**: A small but notable change was made in the `handleRecoveryDirectoryWarnings` function. The explicit check for the existence of `common.RecoveryDirPath` using `afero.Exists` was removed, streamlining the function to directly attempt reading the directory.
    *   **11/21/2025, 2:40:35 PM**: Again, the file content is identical to the previous version, signifying no functional changes.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go:**
    *   **11/21/2025, 4:00:45 PM**: This is a newly introduced file at this timestamp. It serves as the application's entry point, defining the `main` function. It includes `ExitCode` definitions, embeds the application version, parses a `mount` path command-line argument, sets up logging, and orchestrates the primary `run` function. The `run` function calls `handleRecoveryDirectoryWarnings`, `verifyAndInitializeEnvironment`, `enableIntegrity`, and `unlockEncryptedDirs`, managing the overall lifecycle and exit statuses of the Integrity Handler.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go:**
    *   **11/21/2025, 4:11:30 PM**: This is another newly introduced file, detailing the specific integration with the `fscrypt` library. It defines various custom error types related to encryption failures, a `protectorName` constant ("FEMK"), and the `SetupOnMount` function for global and filesystem-level `fscrypt` setup. Crucially, it introduces the `EncryptionResult` structure to track the success and various failure modes of directory encryption, along with the `EncryptTargetDirs` and `encryptTargetDir` functions, which handle the complex process of relocating directory contents, encrypting the target directory, and restoring the contents. It also includes mechanisms for recovery in case of failures during these steps.

**Patterns or recurring elements:**

*   **Copyright and Authorship:** All files are consistently copyrighted to "Juniper Networks, Inc. 2025. All rights reserved."
*   **Security and Integrity Focus:** The overarching theme is maintaining "Config Integrity" through "encryption" using a "FEMK" and leveraging "TPM" for key protection. The application explicitly handles "integrity compromised" states.
*   **Filesystem Management:** There's a strong emphasis on robust filesystem operations, including creating directories, moving files for encryption, and detailed error handling for these operations, often using `afero` (a filesystem abstraction) for flexibility.
*   **Structured Logging and Error Handling:** The code uses a dedicated `log` package for debug, info, warn, and error messages. Error handling is explicit and contextual, frequently employing `errors.New`, `fmt.Errorf("%w: %w", ...)`, and custom error types or result structures (like `EncryptionResult`) to provide detailed feedback on failures.
*   **Standardized Directory Paths:** Key application directories for boot, encrypted keys, migration, recovery, and manifests are centralized as constants in `common/directories.go` and consistently referenced throughout the codebase.
*   **Idempotency:** Comments explicitly state that core functions like `enableIntegrity` and `EncryptTargetDirs` are designed to be idempotent, implying they can be run multiple times without unintended side effects, which is crucial for reliability in system services.
*   **Dependency on `github.com/google/fscrypt`:** The application relies heavily on this external library for low-level filesystem encryption, with various checks and wrappers built around its functionality.

## 11:26:44 PM
The provided code changes detail the development of an "Integrity Handler" application written in Go, focused on securing file systems using `fscrypt` and a Trusted Platform Module (TPM) for key management. The application's core functionality revolves around verifying system requirements, setting up encrypted directories, and handling integrity violations.

### File-Specific Updates:

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go**
    *   **Timestamp: 11/21/2025, 2:26:50 PM**: This file was initially defined, introducing a set of constants for critical directory paths and a key file. These paths include `/boot/integrity` (`BootDirPath`), `/boot/integrity/femk.enc` (`EncryptedKeyPath` for the filesystem encryption master key), `/opt/128technology/integrity/.migration-store` (`MigrationDirPath`), `/opt/128technology/integrity/migration-recovery` (`RecoveryDirPath`), and `/opt/128technology/integrity/manifest.d` (`ManifestDirPath`).
    *   **Timestamp: 11/21/2025, 4:02:40 PM**: A minor cosmetic change was applied, updating the package-level comment from a detailed explanation of secure containers to a more concise "Package common contains common globals used throughout Integrity Handler." The defined constants remained unchanged.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go**
    *   **Timestamps: 11/21/2025, 2:27:15 PM; 2:27:22 PM; 2:28:49 PM; 2:40:35 PM**: This file serves as a core component of the Integrity Handler. Across these timestamps, its content appears consistent, suggesting either no functional changes or minor, non-highlighted changes. It imports various packages including `fscrypt`, `tpm`, `vault`, and `log`. Key functions defined are:
        *   `verifyAndInitializeEnvironment`: Checks system prerequisites like being run as root, kernel version (>= 5.4), filesystem support for encryption, installation of the `fscrypt` command, and initialization of the TPM.
        *   `enableIntegrity`: Orchestrates the encryption process by ensuring necessary directories exist, creating and resolving the FEMK, setting up `fscrypt` on the mount point, and encrypting target directories.
        *   `unlockEncryptedDirs`: Attempts to unlock specified encrypted directories, treating most failures as integrity violations.
        *   `getFsKey`: A lazy-loading function to decrypt the FEMK and store it in a secure container, with precautions to wipe the plaintext key from memory.
        *   `ensureDirectoriesExist`: Creates all required integrity-related directories with specific permissions and attempts to clean the migration directory.
        *   `handleRecoveryDirectoryWarnings`: Logs warnings if residual content is found in the recovery directory, indicating a need for manual intervention after a potential migration failure.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go**
    *   **Timestamp: 11/21/2025, 4:00:45 PM**: This is the application's entry point. It defines custom `ExitCode`s (Success, Failure, Incompatible, Compromised) for process return values. The `main` function sets up logging, parses a `mountPath` flag, and calls the `run` function. The `run` function orchestrates calls to `handleRecoveryDirectoryWarnings`, `verifyAndInitializeEnvironment`, `enableIntegrity`, and `unlockEncryptedDirs`, mapping encountered errors to the appropriate `ExitCode`. It also uses `go:embed` to include a version string.

*   **/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go**
    *   **Timestamp: 11/21/2025, 4:11:30 PM**: This new file introduces specific `fscrypt` wrapper functions. It defines several custom error types, such as `ErrTargetAlreadyEncrypted`, `ErrDestinationNotEmpty`, and `ErrFailedToRelocate`, to provide detailed feedback on `fscrypt` operations. Key functionalities include:
        *   `SetupOnMount`: Performs global `fscrypt` configuration and sets up encryption on a specified mount path, gracefully handling cases where setup has already occurred.
        *   `EncryptionResult` struct: A detailed structure to report the outcome of encryption attempts, categorizing directories into `Success`, `AlreadyEncrypted`, `FailedToRelocate`, `FailedToEncrypt`, `FailedToUnlock`, `FailedToRestore`, and `FailedToRecover`. It includes methods to check for any failures and build a composite error message.
        *   `EncryptTargetDirs`: An idempotent function designed to encrypt multiple target directories. It checks if a directory is already encrypted before proceeding.
        *   `encryptTargetDir`: The core encryption logic for a single directory. It temporarily moves directory contents, recreates the target directory with appropriate permissions, encrypts the now-empty target, and handles potential recovery in case of failures.

### Patterns and Recurring Elements:

*   **Security and Integrity Focus**: All changes highlight a strong commitment to system integrity and data security, leveraging `fscrypt` for encryption and TPM for key management. The application's name, "Integrity Handler," explicitly states this focus.
*   **Detailed Error Handling**: The codebase demonstrates robust error handling, with custom error types for various failure scenarios and a structured approach to aggregating and reporting errors (e.g., `EncryptionResult` in `fscrypt.go`, `ExitCode`s in `main.go`).
*   **Idempotency**: Functions like `enableIntegrity` and `EncryptTargetDirs` are explicitly designed to be idempotent, meaning they can be called multiple times without unintended side effects, which is crucial for reliability in system management applications.
*   **Structured Directory Management**: A clear pattern of using specific, predefined directories for different operational stages (migration, recovery, manifests) is evident, ensuring organized storage and easier troubleshooting.
*   **Juniper Networks Copyright**: All code entries consistently include the "Copyright (c) Juniper Networks, Inc. 2025. All rights reserved." header, indicating ownership and intellectual property.
*   **Consistent Logging**: The use of `log.Debug`, `log.Info`, `log.Warnf`, and `log.Errorf` throughout the code indicates a comprehensive logging strategy for monitoring application behavior and diagnosing issues.