# Activity Summary for 12/1/2025

## 12:26:49 AM
The changes log details the development of a Go application named "Integrity Handler," primarily focused on filesystem encryption and integrity management.

### File-Specific Updates:

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go`**
    *   **11/21/2025, 2:26:50 PM:** This file was initially introduced, defining key constant paths for the Integrity Handler. These include `/boot/integrity` for core files and the encrypted key (`femk.enc`), and `/opt/128technology/integrity` for migration data (`.migration-store`), recovery (`migration-recovery`), and manifest files (`manifest.d`).
    *   **11/21/2025, 4:02:40 PM:** A minor update occurred, changing the package comment from a detailed description of key storage to a general statement about common globals, with no functional code changes.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go`**
    *   **11/21/2025, 2:27:15 PM:** The core logic of the Integrity Handler was implemented. This includes functions for:
        *   `verifyAndInitializeEnvironment`: Checks system requirements like root privileges, kernel version (>= 5.4), filesystem encryption support (using `fscrypt/metadata`), and TPM initialization.
        *   `enableIntegrity`: Orchestrates the encryption process by ensuring directories exist, resolving a Front-End Master Key (FEMK), setting up `fscrypt` on the mount, and encrypting target directories.
        *   `unlockEncryptedDirs`: Handles unlocking encrypted directories.
        *   `getFsKey`: Securely loads the filesystem key from an encrypted FEMK.
        *   `ensureDirectoriesExist`: Creates necessary directories with specific permissions (e.g., `0o750`, `0o700` for `/boot/integrity`) and cleans the migration directory.
        *   `handleRecoveryDirectoryWarnings`: Logs warnings if contents are found in the recovery directory.
    *   **11/21/2025, 2:27:22 PM, 2:28:49 PM, 2:40:35 PM:** Multiple entries for this file show no functional code changes but indicate re-saves or minor non-code modifications over a short period.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go`**
    *   **11/21/2025, 4:00:45 PM:** This file was introduced as the application's entry point. It defines `ExitCode` constants (`ExitSuccess`, `ExitFailure`, `ExitIncompatible`, `ExitCompromised`), embeds a version string, parses a `--mount` flag, and orchestrates the call to `verifyAndInitializeEnvironment`, `enableIntegrity`, and `unlockEncryptedDirs`. It includes logic to handle specific error conditions and return appropriate exit codes, notably `ExitCompromised` for integrity violations.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go`**
    *   **11/21/2025, 4:11:30 PM:** This file was introduced, implementing wrappers around `fscrypt` operations. It defines various error types (e.g., `ErrTargetAlreadyEncrypted`, `ErrFailedToRelocate`), a `protectorName` ("FEMK"), and functions like `SetupOnMount` for global and filesystem `fscrypt` configuration. The `EncryptionResult` struct tracks detailed outcomes of encryption operations. The `EncryptTargetDirs` and `encryptTargetDir` functions implement the core logic for encrypting directories, involving temporary relocation of contents, recreation of empty directories, encryption, and restoration. It relies on constants from the `common` package.
    *   **11/25/2025, 4:04:34 PM:** A significant refactoring was applied. Key changes include:
        *   **Removal of `common` package import:** This led to hardcoding the `tempDir` path within `EncryptTargetDirs`.
        *   **Introduction of specific error types:** `ErrFailedToEncrypt`, `ErrFailedToUnlock`, `ErrFailedToRestore` were explicitly defined, enhancing error granularity.
        *   **Simplification of `EncryptionResult`:** The `FailedToRecover` field was removed, and related logic in `Failed()` and `BuildError()` was updated.
        *   **Refined error handling in `EncryptTargetDirs`:** A `switch` statement was added to explicitly handle different types of failures from `encryptTargetDir` and log messages, along with cleaning up the temporary migration directory on success.
        *   **Modified `encryptTargetDir` signature and internal logic:** The `recoveryDir` parameter was removed, and associated recovery logic within the function was adjusted.

### Timestamps of Significant Changes:

*   **11/21/2025, 2:26:50 PM:** Initial creation of `common/directories.go`.
*   **11/21/2025, 2:27:15 PM:** Initial implementation of the main integrity logic in `integrity.go`.
*   **11/21/2025, 4:00:45 PM:** Introduction of `main.go`, establishing the application's entry point and overall flow.
*   **11/21/2025, 4:11:30 PM:** Initial implementation of the `fscrypt` wrapper logic in `fscrypt/fscrypt.go`.
*   **11/25/2025, 4:04:34 PM:** Major refactoring of `fscrypt/fscrypt.go`, significantly impacting its error handling, dependency management (removal of `common` import), and recovery mechanisms. This occurred several days after the initial development burst.

### Patterns and Recurring Elements:

*   **Copyright Header:** All Go files consistently include the copyright notice `// Copyright (c) Juniper Networks, Inc. 2025. All rights reserved.`.
*   **Integrity Handler Focus:** The entire codebase revolves around an "Integrity Handler" application designed to secure the system, primarily through filesystem encryption managed by `fscrypt` and key management with TPM/vault.
*   **Robust Error Handling:** The code uses `errors.New`, `fmt.Errorf("%w: %w", ...)`, and `errors.Join` extensively to create explicit, chained, and comprehensive error messages. Specific `ExitCode` values are defined for different failure scenarios.
*   **`afero` Filesystem Abstraction:** The `github.com/spf13/afero` library is used across `integrity.go` and `fscrypt/fscrypt.go` for abstracting filesystem operations, suggesting a design that allows for easier testing or different storage backends.
*   **`fscrypt` Integration:** Deep integration with `github.com/google/fscrypt` is central, involving environment checks, setup, and directory encryption/unlocking.
*   **Key Management:** The concept of a "FEMK" (Filesystem Encryption Master Key) and its secure handling via `tpm` and `vault` packages (e.g., `vault.SecureContainer`) is a recurring theme, emphasizing security.
*   **Directory Structure:** A consistent set of specialized directories (`/boot/integrity`, `/opt/128technology/integrity/.migration-store`, `migration-recovery`, `manifest.d`) is used for the application's operations, including temporary data, recovery, and configuration.
*   **Idempotency Requirement:** Both `enableIntegrity` and `EncryptTargetDirs` are explicitly marked as needing to be idempotent, which is crucial for reliability in system management applications.
*   **`log` package usage:** A custom `github.com/Juniper-SSN/ssr/go/src/log` package is used throughout for consistent logging.
*   **TODO Comments:** The presence of `TODO` comments indicates ongoing development and areas for future enhancement, such as "best effort shred," manifest processing, and `path` plumbing for upgrades.

## 1:26:46 AM
The provided code logs detail the development of an "Integrity Handler" Go application, primarily focused on secure filesystem encryption using `fscrypt` and TPM/vTPM integration. The changes span several core files, revealing updates to directory management, environmental checks, and the encryption process itself.

**File-specific updates:**

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go`**
    *   **Timestamp: 11/21/2025, 2:26:50 PM**
        This file initializes constant strings for critical directory paths used by the Integrity Handler. These include `/boot/integrity` (for handler files and the encrypted FEMK), `/opt/128technology/integrity/.migration-store` (for migration data), `/opt/128technology/integrity/migration-recovery` (for recovery data post-migration failure), and `/opt/128technology/integrity/manifest.d` (for integrity manifests). The package comment mentions using a secure container based on mmap'ed and mlocked memory for keys.
    *   **Timestamp: 11/21/2025, 4:02:40 PM**
        A minor documentation update occurred in this commit. The package comment was simplified from detailing the secure container to a more general `Package common contains common globals used throughout Integrity Handler.`. The directory constants themselves remained unchanged.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go`**
    *   **Timestamps: 11/21/2025, 2:27:15 PM, 2:27:22 PM, 2:28:49 PM, 2:40:35 PM**
        Across these timestamps, the content of `integrity.go` appears to be identical. This file contains the core logic for the Integrity Handler application. It defines an `errIntegrityCompromised` error and several key functions:
        *   `verifyAndInitializeEnvironment`: Checks system prerequisites like being run as root, kernel version (>= 5.4), filesystem encryption support (via `fscrypt/metadata`), the presence of the `fscrypt` command, and TPM/vTPM initialization.
        *   `enableIntegrity`: Orchestrates the encryption process by ensuring necessary directories exist, creating/resolving the File Encryption Master Key (FEMK), setting up `fscrypt` on the mount, and initiating the encryption of target directories. It is designed to be idempotent.
        *   `unlockEncryptedDirs`: Handles unlocking previously encrypted directories, flagging integrity compromises on failure.
        *   `getFsKey`: A lazy-loading function that decrypts the FEMK from disk, stores the plaintext key in a `vault.SecureContainer` (a secure memory container), and then wipes the original plaintext key from memory.
        *   `ensureDirectoriesExist`: Creates all required Integrity Handler directories with specific permissions and attempts to clean the migration directory.
        *   `handleRecoveryDirectoryWarnings`: Logs warnings if data is found in the recovery directory, suggesting manual intervention is needed.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go`**
    *   **Timestamp: 11/21/2025, 4:00:45 PM**
        This file serves as the application's entry point. It defines `ExitCode` constants to standardize process return values (e.g., `ExitSuccess`, `ExitIncompatible`, `ExitCompromised`). It embeds the application version and parses a `mount` path argument. The `run` function orchestrates the application's lifecycle: logging, initializing application state, handling recovery warnings, verifying the environment, enabling integrity for default targets, and finally unlocking any already encrypted directories. Error handling is structured to return specific exit codes based on the type of failure.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go`**
    *   **Timestamp: 11/21/2025, 4:11:30 PM**
        This file provides high-level Go wrappers for `fscrypt` operations. It defines numerous specific error constants for various fscrypt-related failures (e.g., `ErrTargetAlreadyEncrypted`, `ErrFailedToRelocate`). The `SetupOnMount` function performs global and filesystem-specific fscrypt setup. The `EncryptionResult` struct tracks the outcome of encrypting multiple directories, including successes, already encrypted paths, and various failure types. The `EncryptTargetDirs` function iterates through target directories, initiating the `encryptTargetDir` process, which involves moving contents out, recreating the directory, encrypting it, and then moving contents back. Error handling includes relocating failed items to a recovery directory.
    *   **Timestamp: 11/25/2025, 4:04:34 PM**
        This timestamp introduces significant refactoring within the `fscrypt.go` file:
        *   **Error Management Refinement**: New dedicated error constants `ErrFailedToEncrypt`, `ErrFailedToUnlock`, and `ErrFailedToRestore` were added, replacing more generic failure handling. Concurrently, the `FailedToRecover` field was removed from the `EncryptionResult` struct and its related methods (`Failed()`, `BuildError()`). This indicates a shift in how specific recovery-related failures are tracked or reported.
        *   **Decoupling from `common`**: The import of the `common` package was removed. This means directory paths like `common.MigrationDirPath` are no longer directly referenced from within `fscrypt.go`. Instead, the `tempDir` path within `EncryptTargetDirs` is now hardcoded.
        *   **Revised Encryption Workflow**: The `encryptTargetDir` function no longer handles the creation of a `recoveryDir` or the migration of contents to it directly. Instead, `encryptTargetDir` now returns an error to its caller (`EncryptTargetDirs`). The `EncryptTargetDirs` function now uses a `switch` statement to categorize and log these returned errors more precisely. If `encryptTargetDir` is successful, `EncryptTargetDirs` explicitly removes the temporary migration directory.
        *   **Permission Handling Simplification**: The `encryptTargetDir` function was simplified by no longer attempting to `fs.Stat(target)` to capture existing directory permissions before recreation. It now defaults to a fixed `os.FileMode(0o0750)`.

**Patterns and Recurring Elements:**

*   **Juniper Networks Copyright (2025):** All files consistently feature the `// Copyright (c) Juniper Networks, Inc. 2025. All rights reserved.` notice.
*   **Integrity Handler Focus:** The application's purpose, "Integrity Handler," is prominent across file comments and functionality.
*   **Secure Key Management:** There is a clear emphasis on managing a File Encryption Master Key (FEMK) securely, utilizing a `vault.SecureContainer` and TPM/vTPM.
*   **Filesystem Encryption (fscrypt):** The `github.com/google/fscrypt` library is central to the encryption logic, along with extensive error handling for various fscrypt-related operations.
*   **Structured Error Handling:** The codebase makes heavy use of Go's `errors` package, including `errors.New`, `fmt.Errorf` with wrapping (`%w`), `errors.Is`, and `errors.Join`, for comprehensive error reporting and classification.
*   **Abstracted Filesystem Operations:** The `github.com/spf13/afero` library is used to abstract filesystem interactions, enabling easier testing and potentially different underlying filesystem implementations.
*   **Logging:** Consistent use of a `log` package (`github.com/Juniper-SSN/ssr/go/src/log`) with different severity levels (Debug, Info, Warn, Error, Errorf).
*   **Directory Standardization:** A set of specific directory paths for boot, encryption keys, migration, recovery, and manifests are defined and consistently used.
*   **Idempotency Requirement:** Key functions like `enableIntegrity` and `EncryptTargetDirs` are explicitly designed and documented to be idempotent.
*   **System Environment Requirements:** The application enforces strict environmental checks, including requiring root privileges and a minimum kernel version, along with filesystem encryption support.

## 2:26:55 AM
The provided log details code changes for an "Integrity Handler" application written in Go, focusing on filesystem encryption, secure key management, and system integrity. The changes span two key dates: November 21, 2025, for initial setup and main logic, and November 25, 2025, for a significant refactor in the `fscrypt` module.

### File-Specific Updates:

1.  **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go`**
    *   **Timestamp: 11/21/2025, 2:26:50 PM**: This file was initially committed, defining essential constant paths for the Integrity Handler, including `BootDirPath` (`/boot/integrity`), `EncryptedKeyPath` (`/boot/integrity/femk.enc`), `MigrationDirPath` (`/opt/128technology/integrity/.migration-store`), `RecoveryDirPath` (`/opt/128technology/integrity/migration-recovery`), and `ManifestDirPath` (`/opt/128technology/integrity/manifest.d`). These paths are crucial for storing integrity-related files and temporary data during encryption/migration.
    *   **Timestamp: 11/21/2025, 4:02:40 PM**: A minor update occurred, changing the package-level comment from a detailed description of a secure container to a more generic "common globals used throughout Integrity Handler." The constant definitions remained unchanged.

2.  **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go`**
    *   **Timestamp: 11/21/2025, 2:27:15 PM**: This substantial file, representing the core logic of the Integrity Handler, was initially committed. It includes:
        *   `verifyAndInitializeEnvironment`: A function to check system prerequisites such as root privileges, kernel version (>= 5.4), filesystem encryption support (via `fscrypt`), and TPM initialization.
        *   `enableIntegrity`: The main function to set up and enable integrity, involving directory creation, File Encryption Master Key (FEMK) handling, `fscrypt` setup, and encrypting target directories. It's explicitly noted as needing to be idempotent.
        *   `unlockEncryptedDirs`: A function to unlock encrypted directories, treating most failures as integrity violations.
        *   `getFsKey`: A lazy-loading mechanism for the filesystem key, stored in a `vault.SecureContainer`.
        *   `ensureDirectoriesExist`: A utility function to create and clean the various directories defined in `common/directories.go`.
        *   `handleRecoveryDirectoryWarnings`: A function to log warnings if any contents are found in the recovery directory.
    *   **Timestamps: 11/21/2025, 2:27:22 PM; 11/21/2025, 2:28:49 PM; 11/21/2025, 2:40:35 PM**: Multiple subsequent entries for this file on the same day show no visible code changes in the provided log snippets, suggesting these were likely minor formatting adjustments, comment updates not captured in the diff, or repeated log entries.

3.  **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go`**
    *   **Timestamp: 11/21/2025, 4:00:45 PM**: This is the application's entry point. Key features include:
        *   Definition of `ExitCode` constants (`ExitSuccess`, `ExitFailure`, `ExitIncompatible`, `ExitCompromised`) that align with systemd service return codes.
        *   Integration of `go:embed` for versioning.
        *   A `main` function that parses command-line arguments (specifically a `mountPath`), sets logging, and calls the primary `run` function.
        *   The `run` function orchestrates the initialization, environment verification, integrity enabling, and directory unlocking processes, mapping any errors to appropriate `ExitCode`s. It contains `TODO`s regarding manifest processing.

4.  **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go`**
    *   **Timestamp: 11/21/2025, 4:11:30 PM**: This file initially provides high-level wrappers for `fscrypt` operations. It defines specific error types (e.g., `ErrTargetAlreadyEncrypted`, `ErrFailedToRelocate`), a `protectorName` constant ("FEMK"), and the `SetupOnMount` function for global `fscrypt` configuration. It introduces the `EncryptionResult` struct to track encryption outcomes and the `EncryptTargetDirs` and `encryptTargetDir` functions for the core encryption logic, including relocating files and encrypting directories. At this stage, `encryptTargetDir` explicitly uses `common.MigrationDirPath`.
    *   **Timestamp: 11/25/2025, 4:04:34 PM**: A significant refactoring was applied.
        *   The `github.com/Juniper-SSN/ssr/go/bin/IntegrityHandler/common` import was removed, indicating a move towards greater encapsulation within the `fscrypt` package.
        *   New, more specific error constants (`ErrFailedToEncrypt`, `ErrFailedToUnlock`, `ErrFailedToRestore`) were introduced for clearer error reporting.
        *   The `EncryptionResult` struct was simplified by removing the `FailedToRecover` field.
        *   Path handling for temporary directories (`tempDir`) was hardcoded to `"/opt/128technology/integrity/.migration-store/" + dirName`, replacing the reliance on the removed `common` import.
        *   The `EncryptTargetDirs` function was refactored to use a `switch` statement for detailed error handling from `encryptTargetDir` and now explicitly attempts to remove temporary directories upon successful encryption. The full internal changes to `encryptTargetDir` are not shown, but the updated call signature and error handling imply a substantial internal rework to return these more granular error types.

### Patterns and Recurring Elements:

*   **Security and Integrity Focus**: The entire codebase is dedicated to an "Integrity Handler" that leverages filesystem encryption (`fscrypt`), Trusted Platform Module (TPM) integration, and secure containers (`vault`) for robust system and data protection.
*   **Go Language Conventions**: Consistent use of Go's error handling patterns (`errors.New`, `fmt.Errorf`, `errors.Is`, `errors.Join`), package structure, and standard library components, alongside external libraries like `afero` for filesystem abstraction.
*   **Copyright**: Every file includes the same copyright notice: "Copyright (c) Juniper Networks, Inc. 2025. All rights reserved."
*   **Directory Management**: A recurring theme is the creation, management, and cleaning of specific directories related to integrity, migration, and recovery, often using `os.FileMode` for permissions.
*   **Idempotency**: Key functions like `enableIntegrity` and `EncryptTargetDirs` are explicitly designed or commented to be idempotent, ensuring reliable operation even if executed multiple times.
*   **Timestamps**: Initial development and core logic setup predominantly occurred on 11/21/2025, followed by a substantial functional refactoring in the `fscrypt` module on 11/25/2025, indicating active and iterative development.

## 3:26:50 AM
The provided log details changes across three Go source files related to an "Integrity Handler" application, with timestamps spanning from November 21st to November 25th, 2025.

**File-Specific Updates:**

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/common/directories.go`**
    *   **11/21/2025, 2:26:50 PM:** This file was initially defined, establishing constants for critical directory paths used by the Integrity Handler. These include `/boot/integrity` for handler files, `/boot/integrity/femk.enc` for the encrypted File Encryption Master Key (FEMK), and `/opt/128technology/integrity/.migration-store`, `/opt/128technology/integrity/migration-recovery`, and `/opt/128technology/integrity/manifest.d` for migration data, recovery data, and integrity manifests, respectively.
    *   **11/21/2025, 4:02:40 PM:** A minor change occurred, updating the package-level comment from a more detailed description of a secure container to a simpler "Package common contains common globals used throughout Integrity Handler." The constants themselves remained unchanged.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/integrity.go`**
    *   **11/21/2025, 2:27:15 PM:** The core logic of the Integrity Handler application was introduced. This includes functions for:
        *   `verifyAndInitializeEnvironment`: Checks system requirements like root privileges, kernel version (>= 5.4), filesystem encryption support (using `fscrypt`), the presence of the `fscrypt` command, and TPM initialization.
        *   `enableIntegrity`: Orchestrates the encryption process by ensuring directories exist, creating/retrieving the FEMK (via `createFEMK` and `getFsKey`), setting up `fscrypt` on the mount, and initiating directory encryption.
        *   `unlockEncryptedDirs`: Handles unlocking previously encrypted directories, treating failures as integrity compromises.
        *   `getFsKey`: Securely loads the filesystem key into a `vault.SecureContainer` after decryption and wipes the plaintext key.
        *   `ensureDirectoriesExist`: Creates all necessary application directories with specific permissions (e.g., `0o750` for migration, `0o700` for boot paths) and attempts to clean the migration directory.
        *   `handleRecoveryDirectoryWarnings`: Logs warnings if residual content is found in the recovery directory.
    *   **11/21/2025, 2:27:22 PM**, **11/21/2025, 2:28:49 PM**, **11/21/2025, 2:40:35 PM:** Multiple entries for this file at these timestamps show no functional changes in the code. These appear to be incidental saves or minor, non-functional edits.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/main.go`**
    *   **11/21/2025, 4:00:45 PM:** This file defines the main entry point for the Integrity Handler application. Key aspects include:
        *   Definition of custom `ExitCode` values (e.g., `ExitSuccess`, `ExitIncompatible`, `ExitCompromised`) that align with systemd service return codes.
        *   Use of `go:embed` to include a version string.
        *   Command-line argument parsing for a `mount` path (defaulting to `/`).
        *   The `run` function orchestrates the application flow: logging the version, handling recovery warnings, verifying the environment, calling `enableIntegrity`, and then `unlockEncryptedDirs` for already encrypted paths. It manages error handling and returns appropriate exit codes based on the outcome, specifically returning `ExitCompromised` for integrity violations.

*   **`/Users/cnesbitt/shared/ssr/go/bin/IntegrityHandler/fscrypt/fscrypt.go`**
    *   **11/21/2025, 4:11:30 PM:** The initial implementation of the `fscrypt` package was added. This package provides high-level wrappers for `fscrypt` operations and includes:
        *   Definitions for various error types related to encryption and filesystem operations.
        *   `SetupOnMount`: A function to perform global and filesystem-specific `fscrypt` setup.
        *   `EncryptionResult` struct: A detailed structure to track the outcome of encryption attempts, categorizing successes, already encrypted targets, and different types of failures (relocation, encryption, unlock, restore, recover).
        *   `EncryptTargetDirs`: The primary function to encrypt target directories, which internally calls `encryptTargetDir` for individual targets.
        *   `encryptTargetDir`: This function outlines a complex multi-step process involving moving contents out of a target directory to a temporary location, recreating the target as an empty encrypted directory, and then moving contents back in. It also included logic for moving contents to a recovery directory in case of certain failures.
    *   **11/25/2025, 4:04:34 PM:** A significant refactoring occurred in this file:
        *   The direct import of the `common` package was removed. As a consequence, paths like `MigrationDirPath` are now hardcoded within `EncryptTargetDirs`.
        *   New explicit `var` error definitions (`ErrFailedToEncrypt`, `ErrFailedToUnlock`, `ErrFailedToRestore`) were introduced, replacing their implicit tracking within `EncryptionResult`. The `FailedToRecover` category was removed from `EncryptionResult` and related error handling.
        *   The `EncryptTargetDirs` function was updated with a `switch` statement to handle different error outcomes from `encryptTargetDir` and now explicitly removes temporary migration directories upon success.
        *   The `encryptTargetDir` function signature changed to accept `tempDir` as an argument, and the internal logic for creating and utilizing a `recoveryDir` during certain failure paths was removed, indicating a shift in recovery strategy to a higher-level handler.

**Patterns and Recurring Elements:**

*   **Copyright:** All files consistently include the copyright notice "Copyright (c) Juniper Networks, Inc. 2025. All rights reserved."
*   **Security Focus:** The codebase is fundamentally about system integrity and encryption, utilizing TPM, fscrypt, and secure key containers (`vault`).
*   **Directory Structure:** A consistent set of specific directories under `/boot/integrity` and `/opt/128technology/integrity` is used for application files, encrypted keys, migration, and recovery data.
*   **Idempotency:** Core functions like `enableIntegrity` and `EncryptTargetDirs` are explicitly designed or intended to be idempotent, meaning they can be run multiple times without causing unintended effects.
*   **Comprehensive Error Handling:** The application demonstrates robust error handling, with custom error types, `errors.Join` for aggregating multiple errors, and specific exit codes (`ExitCode` enum) for `main.go` to provide detailed status information.
*   **Logging:** The `github.com/Juniper-SSN/ssr/go/src/log` package is extensively used throughout, providing debug, info, warning, and error logging capabilities.
*   **Filesystem Abstraction:** The use of `github.com/spf13/afero` indicates a design choice to abstract filesystem operations, making the code potentially more testable or adaptable to different filesystem implementations.