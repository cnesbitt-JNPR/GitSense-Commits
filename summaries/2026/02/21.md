# Activity Summary for 2/21/2026

## 1:02:46 AM
The file `/Users/cnesbitt/shared/ssr/go/bin/ChassisManager/led/heartbeat/monitor.go` was updated on `2/19/2026, 5:12:50 PM`.

This Go code defines a `heartbeat` package designed to periodically check the health of an SSR (Software-defined Secure Router) system by communicating with a `StateMonitor` service.

**Key updates and functionalities include:**

*   **Health Monitoring Interface:** It introduces a `Monitor` interface with methods `Run`, `GetHealth`, and `SetHealth` to manage the health checking process.
*   **Defined Health States:** The code explicitly defines `SSRHealthResponse` types (`SSRUnknownHealth`, `SSRHealthy`, `SSRMajorOrCriticalAlarm`) for responses from the SSR, which are then mapped to internal `api.SSRHealth` statuses like `SSRBooting`, `SSRInService`, `SSRDegradedService`, and `SSROutOfService`.
*   **Polling Mechanism:** The `monitor` struct initiates health checks at a configurable `pollInterval` (defaulting to 3 seconds). The `Run` method continuously polls the SSR, managing failure thresholds for initial booting (100 consecutive failures, roughly 5 minutes) and subsequent reconnections (3 consecutive failures).
*   **Unix Socket Communication:** The `makeHeartbeatRequest` function constructs an HTTP GET request to `/api/v1/ssr/health` via a Unix domain socket (`/var/run/128technology/stateMonitor.sock`), utilizing `unix.NewTransportWithStaticAddress` for communication. Each request includes a 1-second timeout.
*   **Response Handling:** The `handleHeartbeatResponse` method processes the HTTP response, checking for `http.StatusOK`, reading the JSON body, and unmarshaling it to determine the SSR's health status. It translates the raw health response into the internal `api.SSRHealth` types and provides descriptive reasons for non-healthy states.
*   **State Management and Logging:** The `applyHealth` method updates the monitor's health status, ensuring thread safety with a `sync.Mutex`. It also integrates logging, reporting health changes with `log.Infof` for in-service, `log.Warnf` for degraded service, and `log.Errorf` for out-of-service conditions.
*   **Testability:** The implementation provides a `newTestMonitor` function and a configurable `makeRequest` field within the `monitor` struct, allowing for easy mocking and unit testing of the heartbeat request mechanism.